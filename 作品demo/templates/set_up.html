<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
      <title>井盖识别</title>
<link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" type="text/css">
<link href="{{ url_for('static', filename='style_.css') }}" rel="stylesheet" type="text/css">
<link href="{{ url_for('static', filename='material-icons.css') }}" rel="stylesheet">
  <script src="{{ url_for('static', filename='uploads_onnx.js') }}"></script>
      <link rel="icon" href='../static/cover.jpeg'>
</head>

<body>
  <div class="container">
    <aside>
      <div class="top">
        <div class="logo">
          <h1><span class="title">井盖识别</span></h1>
        </div>
        <div class="close" id="close-btn">
          <span class="material-icons-sharp">close</span>
        </div>
      </div>
      <div class="sidebar">
        <a href="index.html">
          <span class="material-icons-sharp">inventory</span>
          <h3>开始检测</h3>
        </a>
        <a href="detections.html">
          <span class="material-icons-sharp">grid_view</span>
          <h3>批量检测</h3>
        </a>
        <a href="analysis.html">
          <span class="material-icons-sharp">insights</span>
          <h3>检测结果分析</h3>
        </a>
        <a href="intro.html">
          <span class="material-icons-sharp">mail_outline</span>
          <h3>网站使用说明</h3>
          <span class="message-count" style="color: white">!</span>
        </a>
        <a href="#" class="active">
          <span class="material-icons-sharp">settings</span>
          <h3>设置</h3>
        </a>
        <a href="user.html">
          <span class="material-icons-sharp">person_outline</span>
          <h3>用户</h3>
        </a>
        <a href="#">
          <span class="material-icons-sharp">inventory</span>
          <h3>项目</h3>
        </a>
        <a href="#">
          <span class="material-icons-sharp">report_gmailerrorred</span>
          <h3>报告</h3>
        </a>

        <a href="#">
          <span class="material-icons-sharp">add</span>
          <h3>添加项目</h3>
          </h3>
        </a>
        <a href="choose.html">
          <span class="material-icons-sharp">logout</span>
          <h3>退出登陆</h3>
        </a>
      </div>
    </aside>
    <main>
      <h1>网站使用说明</h1>
      <div class="date">
        <input type="date">
      </div>
      <div class="insights">
       <p>
        <div class="set_pt">
          <span class="material-icons-sharp">bar_chart</span>
          <div class="left">
            <h1 class="primary">上传您的模型(请使用onnx文件)</h1>
          </div>
          <div class="middle">
             <form id="upload-form" enctype="multipart/form-data">
              <input type="file" id="file-input" name="model-file" class="btn">
                 <button onclick="document.getElementById('file-input').click()" class="btn">选择文件</button>
                <div id="tip" class="primary"></div>
              <button type="submit" id="upload-button" class="btn" style="font-size:20px">上传模型</button>
              <button type="button" id="complete-button" class="btn" style="font-size:20px">使用模型去检测</button>
                <button type="button" id="cancel-button" class="btn" style="font-size:20px">取消使用本次选择的模型</button>
            </form>
          </div>
        </div>
        </p>

        <p>
        <div class="set_pt">
          <span class="material-icons-sharp">bar_chart</span>
          <div class="left">
            <h1 class="primary">上传您的数据集</h1>
          </div>
          <input type='file' id="fileFolder" class="btn" multiple webkitdirectory >
          <button onclick="document.getElementById('fileFolder').click()" class="btn">选择文件夹</button>
          <div class="middle">
              <button class="btn" id="download" taskId="" disabled>点击下载模型文件啦</button>
                <a class="btn" id="result_link"></a>
            <div id="Pic">
            </div>
          </div>
        </div>
        </p>
</div>
      <!-- End of insights -->
    </main>
    <!-- End of main -->
    <div class="right">
      <div class="top">
        <button id="menu-btn">
          <span class="material-icons-sharp">menu</span>
        </button>
        <div class="theme-toggler">
          <span class="material-icons-sharp active">light_mode</span>
          <span class="material-icons-sharp">dark_mode</span>
        </div>
        <div class="profile">
          <div class="info">
              <P><b>welcome</b> to</P>
            <small class="text-muted">our platform</small>
          </div>
          <div class="profile-photo">
              <img src="../static/favicon.ico.jpeg">
          </div>
        </div>
      </div>
      <!-- End of top -->


    </div>
  </div>
  <script src="../static/index.js"></script>
<script src="../static/jquery-3.7.1.min.js"></script>
<script src="../static/plugins/bootstrap-3.4.1/js/bootstrap.js"></script>
<script>
     $('#fileFolder').change(function(e){
         var formdata=new FormData();
         var image0=0;
         var image1=0;
         var label0=0;
         var label1=0;
         const display=$('#display0');
         const display1=$('#display1');
         const upload=$('#upload');

         const run=$('#run');
         const result_text=$('#result_text');
         const result_link=$('#result_link');

         $('#download').prop('disabled',true);
         display.empty();
         display1.empty();
         run.empty();
         upload.text('');
         result_text.text('');
         result_link.removeAttr('href');
        // 移除download属性
         result_link.removeAttr('download');
         result_link.text('等待下载链接');
         var files = e.target.files;
        for(var i=0;i<files.length;i++){
        var path=files[i].webkitRelativePath;
        console.log(files[i])
        var li = $('<li></li>');
        li.text(path);
        display.append(li);
        var arr=path.split('/');
        console.log(arr);
            if(files[i].type.match('image.*')){
                 if(arr[2]==='train'){
                    image0+=1;
                    formdata.append("image_train[]",files[i]);
                }
                else if(arr[2]==='val'){
                image1+=1;
                 formdata.append("image_val[]",files[i]);
                }

            }
            else if(files[i].type==='text/plain'){
                if(arr[2]==='train'){
                label0+=1;
                 formdata.append("label_train[]",files[i]);
                }
                else if(arr[2]==='val'){
                label1+=1;
                 formdata.append("label_val[]",files[i]);
                }
            }

        }
        console.log(image0);
        console.log(image1);
        console.log(label0);
        console.log(label1);

        var li0 = $('<li></li>');
        li0.text('train_image'+image0);
        display1.append(li0);
        var li1 = $('<li></li>');
        li1.text('val_image'+image1);
        display1.append(li1);
        var li2 = $('<li></li>');
        li2.text('train_label'+label0);
        display1.append(li2);
        var li3 = $('<li></li>');
        li3.text('val_label'+label1);
        display1.append(li3);
        if((image0)&&(image1)&&(label0===image0)&&(label1===image1)){
            $.ajax({
                url:'/pt',
                type:'POST',
                data:formdata,
                async:true,
                processData:false,
                contentType:false,
                success:function (response){
                    upload.text('文件上传已经成功，您的训练序号是'+response.taskID)
                    startPollingForResult(response.taskID)
                },
                error:function (xhr,status,error){
                     upload.text("文件上传有误！请检查后重新操作！")
                    alert("文件上传有误！请检查后重新操作！")
                }
            })
        }
        else{
            alert('您上传的文件可能存在错误！无法进行模型训练！请保证images和labels两个文件夹内相应层次的图片和标签数目相等！并注意文件层次是否符合标准！');
        }
     })
function startPollingForResult(taskId) {
    var intervalId = setInterval(function() {
        $.get('/check_task_status', { taskId: taskId }, function(response) {
            if (response.status === 'completed') {
                // 结果已准备好，停止轮询并处理结果
                setTimeout(function() {
                     clearInterval(intervalId);
                     $('#run').text('训练成功！');
                     $('#download').prop('disabled',false);
                     $('#download').data('taskId',taskId);
                }, 30000); // 等待5秒后下载

            } else if (response.status === 'running') {
                $('#run').text('模型正在训练中，请耐心等待')
                // 结果还没准备好，继续轮询
            } else {
                $('#run').text('本次模型训练失败，请检查模型训练的图片和标签是否存在问题')
                clearInterval(intervalId);
            }
        });
    }, 10000); // 每15秒轮询一次
}
$('#download').on('click',function (){
    console.log('按钮可以可以可以可以被点击！！');

    const a_down = $('#result_link');
    // 设置a标签的href属性
    taskId=$('#download').data('taskId')
    console.log(taskId);
    a_down.attr('href', '/download_folder/' + taskId);
    // 设置a标签的文本内容（这里假设我们想要文本为"下载模型"）
    a_down.text('下载模型');
    a_down.attr('download', 'model.zip'); // 假设模型文件名是model.zip
    // 如果需要，给a标签添加下载属性（如果需要强制下载而不是打开链接）
})
</script>
</body>

</html>